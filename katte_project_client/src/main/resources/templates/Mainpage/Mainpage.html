<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>ë©”ì¸ í˜ì´ì§€</title>
  <!-- ì‚¬ì´ë“œë°” CSS ë¶„ë¦¬ ìŠ¤íƒ€ì¼ ì ìš© -->
  <link rel="stylesheet" href="/css/fragments/Sidebar.css" />
  <link rel="stylesheet" href="/css/Mainpage/Mainpage.css" />
  <link rel="stylesheet" href="/css/Mainpage/shorts.css" />
</head>
<body>
<!-- ì‚¬ì´ë“œë°” HTML ë¶„ë¦¬ -->
<div th:replace="Fragments/Sidebar :: sidebar"></div>
<div class="wrapper">


  <!-- ì‡¼ì¸  í”¼ë“œ ì‹œì‘ -->
  <div class="shorts-feed">
    <div class="shorts-scroll-wrapper" id="shortsFeed">
      <!-- JavaScriptë¡œ ì‡¼ì¸ ê°€ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
    </div>
  </div>


  <!-- ğŸ“¦ ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œ ì¹´ë“œ ë ˆì´ì•„ì›ƒ -->
  <div class="right-panel">
    <!-- ğŸ“Š ì‹œì„¸í‘œ ì¹´ë“œ -->
    <div class="price-chart-card">
      <div class="chart-header">
        <h3>ì‹œì„¸í‘œ <span id="chartProductName"></span></h3>
        <span></span>
        <div class="range-selector">
          <button onclick="onChartRangeButtonClick('1m')">1ê°œì›”</button>
          <button onclick="onChartRangeButtonClick('3m')">3ê°œì›”</button>
          <button onclick="onChartRangeButtonClick('6m')">6ê°œì›”</button>
          <button onclick="onChartRangeButtonClick('1y')">1ë…„</button>
          <button onclick="onChartRangeButtonClick('all')">ì „ì²´</button>
        </div>
      </div>
      <canvas id="priceChart"></canvas>
    </div>

    <!-- ğŸ‘— ìŠ¤íƒ€ì¼ ë¦¬ë·° ì¹´ë“œ -->
    <div class="style-review-card">
      <div class="style-header">
        <h3>ìŠ¤íƒ€ì¼ ë¦¬ë·°</h3>
      </div>
      <div class="style-carousel">
        <button class="nav-btn left" onclick="prevReview()">â€¹</button>
        <div id="styleReviewContainer" style="flex: 1; display: flex; justify-content: center;">
          <!-- JavaScriptì—ì„œ style review ì•„ì´í…œ ë™ì ìœ¼ë¡œ ì¶”ê°€ -->
        </div>
        <button class="nav-btn right" onclick="nextReview()">â€º</button>
      </div>
    </div>
  </div>

  <!-- âœ… ë¨¼ì € CDNì„ ë¡œë“œ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


  <script th:inline="javascript" >
    let hasUserInteracted = false;

    window.addEventListener("click", () => hasUserInteracted = true);
    window.addEventListener("scroll", () => hasUserInteracted = true);

    let currentIndex = 0;
    let isLoading = false;

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        const video = entry.target;
        if (entry.isIntersecting) {
          video.muted = false;
          video.play().catch(err => console.warn("ì¬ìƒ ì‹¤íŒ¨:", err));
        } else {
          video.pause();
          video.muted = true;
        }
      });
    }, { threshold: 0.3 });

    async function loadNextShort() {
      if (isLoading) return;
      isLoading = true;

      try {
        const res = await fetch(`/shortform/random`);
        if (!res.ok) return;

        const short = await res.json();
        const isFirst = currentIndex === 0;

        appendShortToDOM(short, isFirst);
        currentIndex++;
      } catch (e) {
        console.error("ğŸ”¥ ì‡¼ì¸  ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", e);
      } finally {
        isLoading = false;
      }
    }

    async function loadStyle(direction) {
      const response = await fetch(`/style/${direction}`);
      const data = await response.json();

      //ë©”ì¸ ì´ë¯¸ì§€ ë³€ê²½
      document.querySelector('.image-65').src = data.imageUrl;
      //í”„ë¡œí•„, ì¢‹ì•„ìš”, ë‹‰ë„¤ì„, í•´ì‹œíƒœê·¸ ë“±ë„ ì—…ë°ì´íŠ¸
      document.querySelector('.div20').src = data.profileUrl;
      document.querySelector('._730-em-0').textContent = data.nickname;
      document.querySelector('._4').innerHTML = data.hashtags;
    }

    function loadNextStyle() {
      loadStyle("next");
    }

    function loadPrevStyle() {
      loadStyle("prev");
    }
    function appendShortToDOM(short, isFirst = false) {
      const wrapper = document.getElementById("shortsFeed");

      // âœ… ì „ì²´ ë˜í¼: short-item-wrapper
      const outer = document.createElement("div");
      outer.className = "short-item-wrapper";

      // âœ… ì—¬ê¸° ì¶”ê°€!
      outer.dataset.productId = short.product_id;

      // âœ… ë‚´ë¶€ ì½˜í…ì¸ : short-item + short-inner-wrapper
      const div = document.createElement("div");
      div.className = "short-item";

      const isLoggedIn = /*[[${session.currentUser != null}]]*/ false;

      div.innerHTML = `
    <div class="short-inner-wrapper">
      <div class="loader"></div>
      <div class="overlay-top"></div>
      <video class="short-video" src="${short.content_url}" preload="auto" muted playsinline loop></video>

      <div class="short-title-row">
        <a href="/user/${short.user_id}" class="profile-thumbnail">
          <img src="${short.profileImgUrl}" alt="ìœ ì € í”„ë¡œí•„">
        </a>
        <div class="short-title-text">
          ${short.title}
          <div class="view-count">${short.total_view} view</div>
        </div>
      </div>
<div class="short-info">
  <div class="price-info">
    <div>
      <div class="label">í˜„ì¬ê°€</div>
      <div class="value">${short.current_price != null ? short.current_price + ' â‚©' : '-'}</div>
    </div>
    <div>
      <div class="label">ì¦‰ì‹œ êµ¬ë§¤</div>
      <div class="value">${short.buy_price != null ? short.buy_price + ' â‚©' : '-'}</div>
    </div>
  </div>
</div>
<div class="progress-wrapper">
  <input type="range" class="progress-bar" value="0" />
  <a class="product-link" href="/product/${short.product_id}"></a>
</div>

      <div class="overlay-bottom"></div>
    </div>

    <div class="no-audio" style="display:none; position:absolute; bottom:20px; right:13px; color:white; background-color:rgba(0,0,0,0.5); padding:5px; border-radius:5px; font-size:12px;">
      <img src="/img/not_sound.png" style="width:16px; vertical-align:middle; margin-right:5px;"/>
      ì†Œë¦¬ ì—†ìŒ
    </div>
  `;

      // âœ… ë²„íŠ¼ì€ .short-item-wrapperì˜ í•˜ìœ„ë¡œ ì¶”ê°€ (overflow ì˜í–¥ ì—†ìŒ)
      const buttons = document.createElement("div");
      buttons.className = "short-buttons-outside";
      buttons.innerHTML = `
    ${isLoggedIn ? `
      <button onclick="likeShort(this)" data-id="${short.id}">
        <img src="/img/heart_icon_no_clicked.png" alt="ì¢‹ì•„ìš”" />
        <span class="like-count">${short.shortform_like_count}</span>
      </button>` : ''
      }
    <button onclick="shareShort(${short.product_id})">
      <img src="/img/shared.png" alt="ê³µìœ " />
    </button>
    <button onclick="toggleMute(this)">
      <img src="/img/mute_off.png" alt="ìŒì†Œê±°" />
    </button>
  `;

      // âœ… ì¡°ë¦½
      outer.appendChild(div);
      outer.appendChild(buttons);
      wrapper.appendChild(outer);

      // âœ… ë¹„ë””ì˜¤ ì²˜ë¦¬
      const video = div.querySelector("video");
      const bar = div.querySelector(".progress-bar");
      const loader = div.querySelector(".loader");
      const noAudio = div.querySelector(".no-audio");

      video.load();

      const timeout = setTimeout(() => {
        console.warn("â° ë¡œë”© ì§€ì—° â†’ ê°•ì œ ì¬ìƒ ì‹œë„");
        video.play().catch(() => {});
      }, 2000);

      video.addEventListener("loadeddata", () => {
        clearTimeout(timeout);
        loader.style.display = "none";

        setTimeout(() => {
          const hasAudio = typeof video.webkitAudioDecodedByteCount !== "undefined"
                  ? video.webkitAudioDecodedByteCount > 0
                  : video.mozHasAudio || (video.audioTracks && video.audioTracks.length > 0);
          noAudio.style.display = hasAudio ? "none" : "block";
        }, 300);

        if (isFirst) {
          video.muted = !hasUserInteracted;
          video.play().catch(err => console.warn("ğŸ¬ ì²« ì˜ìƒ ì¬ìƒ ì‹¤íŒ¨", err));
        }

        observer.observe(video);
      });

      // ğŸ¯ ì¬ìƒë°”
      let isSeeking = false;
      bar.addEventListener("mousedown", () => isSeeking = true);
      bar.addEventListener("mouseup", () => {
        isSeeking = false;
        video.currentTime = bar.value;
      });
      video.addEventListener("timeupdate", () => {
        if (!isSeeking) {
          bar.max = video.duration || 1;
          bar.value = video.currentTime;
        }
      });

      // âœ… ë§ˆì§€ë§‰ ë°©ì–´ ì¬ìƒ ì‹œë„
      video.play().catch(() => {});
    }

    function toggleMute(button) {
      // ì•ˆì „í•˜ê²Œ íƒìƒ‰
      let wrapper = button.closest(".short-item-wrapper");
      if (!wrapper) {
        console.warn("â— short-item-wrapper ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
        return;
      }

      const video = wrapper.querySelector("video");
      if (!video) {
        console.warn("â— video ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
        return;
      }

      video.muted = !video.muted;

      const img = button.querySelector("img");
      img.src = video.muted ? "/img/mute_on.png" : "/img/mute_off.png";
    }

      function likeShort(button) {
        const shortId = button.getAttribute("data-id");
        const countSpan = button.querySelector(".like-count");
        const img = button.querySelector("img");

        fetch(`/shortform/like?short_id=${shortId}`)
                .then(res => res.json())
                .then(isLiked => {
                  let count = parseInt(countSpan.textContent);
                  console.log("like  ? " + isLiked)
                  console.log("count" + count)

                  if (isLiked) {
                    // ì¢‹ì•„ìš”ê°€ ëˆŒë¦¼
                    countSpan.textContent = count + 1;
                    img.src = "/img/heart_icon_clicked.png";
                    countSpan.style.color = "red";
                  } else {
                    // ì¢‹ì•„ìš”ê°€ ì·¨ì†Œë¨
                    countSpan.textContent = count - 1;
                    img.src = "/img/heart_icon_no_clicked.png";
                    countSpan.style.color = "white";
                  }
                  // âœ… í´ë˜ìŠ¤ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
                  countSpan.classList.remove("liked", "unliked");
                  countSpan.classList.add(isLiked ? "liked" : "unliked");
                })
                .catch(err => {
                  console.error("ì¢‹ì•„ìš” ìš”ì²­ ì‹¤íŒ¨", err);
                });
      }

    function shareShort(short_id) {
      navigator.clipboard.writeText(window.origin + "/product/" + short_id);
      alert("ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤");
    }

      window.addEventListener("wheel", (e) => {
        if (e.deltaY > 0) loadNextShort();
      });

    window.addEventListener("DOMContentLoaded", () => {
      if (hasUserInteracted) {
        loadNextShort();
      } else {
        const waitForClick = () => {
          hasUserInteracted = true;
          loadNextShort();
          window.removeEventListener("click", waitForClick);
        };

        window.addEventListener("click", waitForClick);

        // â± 2ì´ˆ ë’¤ ìë™ ì‹¤í–‰ (ì‹¤ì œ í´ë¦­ì€ ì•„ë‹˜)
        setTimeout(() => {
          if (!hasUserInteracted) {
            console.warn("â° ìë™ ìƒí˜¸ì‘ìš© ì‹œë„ ì¤‘...");
            hasUserInteracted = true;
            loadNextShort();
          }
        }, 2000);
      }
    });

    function getCurrentProductId() {
      const shorts = document.querySelectorAll(".short-item-wrapper");
      for (let el of shorts) {
        const rect = el.getBoundingClientRect();
        const inView = rect.top >= 0 && rect.bottom <= window.innerHeight;
        if (inView) {
          return el.dataset.productId;
        }
      }
      return null;
    }

//ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œ ê¸°ëŠ¥êµ¬í˜„
    let currentReviewIndex = 0;
    let reviewItems = [];

    function changeChartRange(range, product_id) {
      fetch(`/price_history?range=${range}&productId=${product_id}`) // ì˜ˆì‹œ
              .then(res => res.json())
              .then(data => {
                const labels = data.map(d => d.ordered_at);
                const prices = data.map(d => d.final_price);
                updateChart(labels, prices);
              });
    }

    function updateChart(labels, data) {
      if (window.priceChart) {
        window.priceChart.data.labels = labels;
        window.priceChart.data.datasets[0].data = data;
        window.priceChart.update();
      }
    }

    function initChart() {
      const ctx = document.getElementById('priceChart').getContext('2d');
      window.priceChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'ê°€ê²©',
            data: [],
            borderColor: '#ff5f5f',
            borderWidth: 2,
            fill: false,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              ticks: {
                color: '#ccc'
              }
            },
            x: {
              ticks: {
                color: '#ccc'
              }
            }
          }
        }
      });
    }

    function loadStyleReviews(product_id) {
      fetch(`/content/styleProductId?product_id=${product_id}`)
              .then(res => res.json())
              .then(data => {
                reviewItems = data;
                renderReview(currentReviewIndex);
              });
    }

    resourceURL = "https://resources-katte.jp.ngrok.io/";
    function renderReview(index) {
      const container = document.getElementById('styleReviewContainer');
      container.innerHTML = '';
      if (!reviewItems.length) return;

      const review = reviewItems[index];
      const div = document.createElement('div');
      const sumitURL = resourceURL+"style/"+review.id+"/"+review.id+"_1.png";
      div.className = 'review-item';
      div.style = `
                  text-align: center;
                  max-width: 250px;
                  `;
      div.innerHTML = `
        <a href="/style/${review.styleId}" style="display: inline-block;">
        <img src="${sumitURL}"
           alt="ìŠ¤íƒ€ì¼ ì´ë¯¸ì§€"
           style="width: 100%; object-fit: cover; border-radius: 12px;" />
        </a>
        <div style="margin-top: 8px; font-size: 14px; color: #ddd; word-break: keep-all;">
            ${review.caption}
    </div>
  `;
      container.appendChild(div);
    }

    function prevReview() {
      currentReviewIndex = (currentReviewIndex - 1 + reviewItems.length) % reviewItems.length;
      renderReview(currentReviewIndex);
    }

    function nextReview() {
      currentReviewIndex = (currentReviewIndex + 1) % reviewItems.length;
      renderReview(currentReviewIndex);
    }

    window.addEventListener('load', () => {
      initChart();
      console.log("AAAAAA")

      const productId = getCurrentProductId();
      if (productId) {
        changeChartRange('1m', productId);
        loadStyleReviews(productId);
      }
    });

    const shortItemObserver = new MutationObserver(() => {
      const productId = getCurrentProductId();
      if (productId !== null) {
        console.log("âœ… productId:", productId);
        changeChartRange('1m', productId);
        loadStyleReviews(productId);
        shortItemObserver.disconnect();
      }
    });

    shortItemObserver.observe(document.body, {
      childList: true,
      subtree: true
    });

    function onChartRangeButtonClick(range) {
      const productId = getCurrentProductId();
      if (!productId) {
        alert("í˜„ì¬ ì¬ìƒ ì¤‘ì¸ ì œí’ˆ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      changeChartRange(range, productId);
    }
  </script>
  </div>
</body>
</html>
