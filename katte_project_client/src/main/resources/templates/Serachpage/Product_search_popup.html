<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ìƒí’ˆ ê²€ìƒ‰</title>
  <style>
    body {
      background: #181818;
      color: white;
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    input, button {
      padding: 8px;
      margin-right: 10px;
    }
    .result-item {
      padding: 10px;
      border-bottom: 1px solid #555;
      cursor: pointer;
    }
    .result-item:hover {
      background: #333;
    }
  </style>
</head>
<body>
<h2>ìƒí’ˆ ê²€ìƒ‰</h2>

<input type="text" id="searchInput" placeholder="ìƒí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”" oninput="liveSearch()" />
<div id="resultBox">
  <p>ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</p>
</div>


<script>
  let debounceTimer;

  function liveSearch() {
    clearTimeout(debounceTimer);

    debounceTimer = setTimeout(() => {
      const keyword = document.getElementById("searchInput").value.trim();

      if (keyword.length < 3) {
        document.getElementById("resultBox").innerHTML = "<p>3ê¸€ì ì´ìƒ ì…ë ¥í•´ ì£¼ì„¸ìš”.</p>";
        return;
      }

      fetch(`https://api-katte.jp.ngrok.io/search?type=PRODUCT&keyword=${keyword}`)
        .then(response => response.json())
        .then(data => {
          const box = document.getElementById("resultBox");
          box.innerHTML = "";

          if (data.length === 0) {
            box.innerHTML = "<p>ğŸ” ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
            return;
          }

          //ê°’ ë„˜ê¸°ê¸°
          data.forEach(item => {
            const li = document.createElement("div");
            li.className = "result-item";
            li.textContent = item.product_name;

            li.onclick = () => {
            console.log("ì„ íƒëœ ìƒí’ˆ:", item);

            // íŒë§¤ ë“±ë¡ í˜ì´ì§€ìš© í•¨ìˆ˜
            if (typeof opener.setProductTag === "function") {
              const categoryStr = Array.isArray(item.category) ? item.category.join(',') : item.category;
              opener.setProductTag(item.product_name, item.product_id, categoryStr);
            }

            // ìŠ¤íƒ€ì¼ ë“±ë¡ í˜ì´ì§€ìš© í•¨ìˆ˜
            else if (typeof opener.setStyleTag === "function") {
            opener.setStyleTag (item.product_name, item.product_id);
            }

  window.close();
}

            box.appendChild(li);  // âœ… DOMì— ì¶”ê°€
          });
        })
        .catch(error => {
          console.error("ê²€ìƒ‰ ì˜¤ë¥˜:", error);
          document.getElementById("resultBox").innerHTML = "<p style='color:red;'>ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ</p>";
        });
    }, 300);
  }
</script>

</body>
</html>
