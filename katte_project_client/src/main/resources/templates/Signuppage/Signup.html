<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>íšŒì›ê°€ì…</title>
  <link rel="stylesheet" href="/css/Signuppage/Signup.css" />
</head>
<body>
<aside class="sidebar">
  <a href="/main">
    <img class="logo-1" src="/img/logo%20(1).png" alt="ë¡œê³ " />
  </a>
  <nav class="sidebar-nav">
    <ul>
      <li><a href="/search">ê²€ìƒ‰</a></li>
      <li><a href="/explore">íƒìƒ‰</a></li>
      <li><a href="/sell">íŒë§¤ë“±ë¡</a></li>
      <li><a href="/wishlist">ê´€ì‹¬ìƒí’ˆ</a></li>
      <li><a href="/style">ìŠ¤íƒ€ì¼</a></li>
      <li><a href="/mypage">ë§ˆì´í˜ì´ì§€</a></li>
      <li><a href="/support">ê³ ê°ì„¼í„°</a></li>
    </ul>
  </nav>
  <div class="login-area">
    <a href="/login" class="btn-login">ë¡œê·¸ì¸</a>
  </div>
  <footer class="sidebar-footer">
    <p><a href="/support">ê³ ê°ì„¼í„°</a> | <a href="/terms">ì´ìš©ì•½ê´€</a></p>
    <small>&copy; All copyright in soldesk</small>
  </footer>
</aside>

<div class="wrapper">
  <form action="/signUp_pro" method="POST">
    <div class="group-957">
      <div class="id">E-Mail</div>
      <label id="email-error-label" class="error-label"></label>
      <input type="text" name="email_id" class="input-id" placeholder="E-Mailë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”" required />
    </div>
    <div class="group-958">
      <div class="password2">Password</div>
      <label id="pw-error-label" class="error-label"></label>
      <input type="password" name="password" class="input-pw" placeholder="Passwordë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”" required />
    </div>
    <div class="group-959">
      <div class="date-of-birth">Date of Birth</div>
      <select name="birthYear" id="birthYear" class="rectangle-16673"></select>
      <div class="div13">ë…„</div>
      <select name="birthMonth" id="birthMonth" class="rectangle-1668"></select>
      <div class="div14">ì›”</div>
      <select name="birthDay" id="birthDay" class="rectangle-1669"></select>
      <div class="div15">ì¼</div>
    </div>
    <div class="group-963">
      <div class="nickname2">Nickname</div>
      <label id="nickname-error-label" class="error-label"></label>
      <input type="text" name="nickname" class="nickname" placeholder="Nicknameì„ ì…ë ¥í•´ ì£¼ì„¸ìš”" required />
    </div>

    <div class="group-965">
      <input type="checkbox" id="over14" name="terms" required />
      <label for="over14" class="_14">[í•„ìˆ˜] ë§Œ 14ì„¸ ì´ìƒì…ë‹ˆë‹¤.</label>
    </div>
    <div class="group-966">
      <input type="checkbox" id="terms1" name="terms" required />
      <label for="terms1" class="div17">[í•„ìˆ˜] ì´ìš© ì•½ê´€ ë™ì˜</label>
    </div>
    <div class="group-967">
      <input type="checkbox" id="terms2" name="terms" required />
      <label for="terms2" class="div18">[í•„ìˆ˜] ê°œì¸ ì •ë³´ ìˆ˜ì§‘ ë° ë™ì˜</label>
    </div>
    <div class="group-968">
      <input type="checkbox" id="terms3" name="terms" />
      <label for="terms3" class="div19">[ì„ íƒ] ê´‘ê³ ì„± í™ë³´ ìˆ˜ì‹  ë™ì˜</label>
    </div>

    <div class="group-969">
      <button type="submit" class="div16">ë³¸ì¸ì¸ì¦í•˜ê³  ê°€ì…</button>
    </div>
  </form>
</div>

<script>
  // ë…„ë„ ì…€ë ‰íŠ¸ë°•ìŠ¤
  const yearSelect = document.getElementById('birthYear');
  const monthSelect = document.getElementById('birthMonth');
  const daySelect = document.getElementById('birthDay');

  const now = new Date();
  const currentYear = now.getFullYear();

  for (let y = currentYear; y >= 1900; y--) {
    yearSelect.innerHTML += `<option value="${y}">${y}</option>`;
  }
  for (let m = 1; m <= 12; m++) {
    monthSelect.innerHTML += `<option value="${m}">${m}</option>`;
  }
  function updateDays() {
    const year = parseInt(yearSelect.value);
    const month = parseInt(monthSelect.value);
    const lastDay = new Date(year, month, 0).getDate();

    daySelect.innerHTML = '';
    for (let d = 1; d <= lastDay; d++) {
      daySelect.innerHTML += `<option value="${d}">${d}</option>`;
    }
  }
  yearSelect.addEventListener('change', updateDays);
  monthSelect.addEventListener('change', updateDays);
  updateDays(); // ì´ˆê¸° ì‹¤í–‰


  const emailInput = document.querySelector('input[name="email_id"]');
  const passwordInput = document.querySelector('input[name="password"]');
  const nicknameInput = document.querySelector('input[name="nickname"]');
  const emailError = document.getElementById("email-error-label");
  const pwError = document.getElementById("pw-error-label");
  const nicknameError = document.getElementById("nickname-error-label");
  const submitButton = document.querySelector('button[type="submit"]');

  let isEmailFormatValid = false;
  let isEmailNotDuplicate = false;
  let isPasswordValid = false;
  let isNicknameFilled = false;

  const BASE_URL = /*[[${apiBaseUrl}]]*/ "http://localhost:9000/";
  console.log("âœ… BASE_URL =", BASE_URL);

  function validateEmailFormat(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }

  function validatePassword(password) {
    return /^(?=.*[0-9])(?=.*[!@#$%^&*])[A-Za-z0-9!@#$%^&*]{8,}$/.test(password);
  }

  async function checkEmailDuplicate(email) {
    try {
      const url = `${BASE_URL}user/duplicate?email_id=${encodeURIComponent(email)}`;
      console.log("ğŸ“¡ ìš”ì²­ URL:", url);

      const response = await fetch(url, { method: "GET" });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const result = await response.json();  // JSON íŒŒì‹±
      console.log("ğŸ“¦ ì‘ë‹µ ê²°ê³¼:", result);

      // ì„œë²„ê°€ { duplicate: true/false } í˜•ì‹ìœ¼ë¡œ ë¦¬í„´í•œë‹¤ê³  ê°€ì •
      return !result;
    } catch (err) {
      console.error("âŒ ì´ë©”ì¼ ì¤‘ë³µ í™•ì¸ ì˜¤ë¥˜:", err);
      return false;
    }
  }

  async function validateEmail() {
    const email = emailInput.value.trim();
    isEmailFormatValid = validateEmailFormat(email);

    if (!isEmailFormatValid) {
      emailError.textContent = "ìœ íš¨í•œ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.";
      isEmailNotDuplicate = false;
    } else {
      // AJAX ì¤‘ë³µ ê²€ì‚¬
      const notDuplicate = await checkEmailDuplicate(email);
      console.log("TTTTTTT" + notDuplicate)
      isEmailNotDuplicate = notDuplicate;
      emailError.textContent = notDuplicate ? "ã…ã…ã…ã…ã…" : "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.";
    }

    updateSubmitButton();
  }

  function validatePw() {
    const pw = passwordInput.value;
    isPasswordValid = validatePassword(pw);
    pwError.textContent = isPasswordValid ? "" : "íŠ¹ìˆ˜,ì˜ë¬¸ í¬í•¨ 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.";
    updateSubmitButton();
  }

  function validateNick() {
    const nick = nicknameInput.value.trim();
    isNicknameFilled = nick.length > 0;
    nicknameError.textContent = isNicknameFilled ? "" : "ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
    updateSubmitButton();
  }

  function areAllTermsChecked() {
    const requiredTerms = document.querySelectorAll('input[name="terms"]:required');
    return Array.from(requiredTerms).every(cb => cb.checked);
  }

  function updateSubmitButton() {
    const isFormValid = isEmailFormatValid && isEmailNotDuplicate && isPasswordValid && isNicknameFilled && areAllTermsChecked();
    submitButton.disabled = !isFormValid;
  }

  // ì´ë²¤íŠ¸ ë°”ì¸ë”©
  emailInput.addEventListener("blur", validateEmail);
  passwordInput.addEventListener("blur", validatePw);
  nicknameInput.addEventListener("blur", validateNick);

  document.querySelectorAll('input[name="terms"]').forEach(cb => {
    cb.addEventListener('change', updateSubmitButton);
  });
</script>
</body>
</html>