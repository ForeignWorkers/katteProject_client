<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>íšŒì›ê°€ì…</title>
  <link rel="stylesheet" href="/css/Signuppage/Signup.css" />
  <!-- ì‚¬ì´ë“œë°” CSS ë¶„ë¦¬ ìŠ¤íƒ€ì¼ ì ìš© -->
  <link rel="stylesheet" href="/css/fragments/Sidebar.css" />
</head>
<body>
<!-- ì‚¬ì´ë“œë°” HTML ë¶„ë¦¬ -->
<div th:replace="Fragments/Sidebar :: sidebar"></div>
<div class="wrapper">
  <form action="/signUp_pro" method="POST">
    <div class="group-957">
      <div class="id">E-Mail</div>
      <input type="text" name="email_id" class="input-id" placeholder="E-Mailë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”" required />
      <label id="email-error-label" class="error-label"></label>
    </div>
    <div class="group-958">
      <div class="password2">Password</div>
      <input type="password" name="password" class="input-pw" placeholder="Passwordë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”" required />
      <label id="pw-error-label" class="error-label"></label>
    </div>
    <div class="group-958">
      <div class="password2" style="top: 500.65px;"></div>
      <input type="password" name="confirm_password" class="input-pw" id="confirmPasswordInput" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•´ ì£¼ì„¸ìš”" style="top: 329.75px;" required />
      <label id="pw-confirm-error-label" class="error-label"></label>
    </div>
    <div class="group-959">
      <div class="date-of-birth" style="top: 400.15px;">Date of Birth</div>
      <select name="birthYear" id="birthYear" class="rectangle-16673" style="top: 446.35px;"></select>
      <div class="div13" style="top: 452.3px;">ë…„</div>
      <select name="birthMonth" id="birthMonth" class="rectangle-1668" style="top: 446.35px;"></select>
      <div class="div14" style="top: 452.3px;">ì›”</div>
      <select name="birthDay" id="birthDay" class="rectangle-1669" style="top: 446.35px;"></select>
      <div class="div15" style="top: 452.3px;">ì¼</div>
    </div>
    <div class="group-963">
      <div class="nickname2" style="top: 504.15px;">Nickname</div>
      <input type="text" name="nickname" class="nickname" placeholder="Nicknameì„ ì…ë ¥í•´ ì£¼ì„¸ìš”" required maxlength="12" style="top: 544.7px;" />
      <label id="nickname-error-label" class="error-label"></label>
    </div>
    <div class="group-965" style="top: 620px;">
      <input type="checkbox" id="over14" name="over14" />
      <label for="over14" class="_14">[í•„ìˆ˜] ë§Œ 14ì„¸ ì´ìƒì…ë‹ˆë‹¤.</label>
    </div>
    <div class="group-966" style="top: 655px;">
      <input type="checkbox" id="terms1" name="terms1" />
      <label for="terms1" class="div17">[í•„ìˆ˜] ì´ìš© ì•½ê´€ ë™ì˜</label>
    </div>
    <div class="group-967" style="top: 690px;">
      <input type="checkbox" id="terms2" name="terms2" />
      <label for="terms2" class="div18">[í•„ìˆ˜] ê°œì¸ ì •ë³´ ìˆ˜ì§‘ ë° ë™ì˜</label>
    </div>
    <div class="group-968" style="top: 725px;">
      <input type="checkbox" id="terms3" name="terms3" />
      <label for="terms3" class="div19">[ì„ íƒ] ê´‘ê³ ì„± í™ë³´ ìˆ˜ì‹  ë™ì˜</label>
    </div>
    <div class="group-969">
      <button type="submit" class="div16" style="top: 790px;">ë³¸ì¸ì¸ì¦í•˜ê³  ê°€ì…</button>
      <label id="terms-error-label" class="error-label"></label>
    </div>
  </form>
</div>


<script>
  // ë…„ë„ ì…€ë ‰íŠ¸ë°•ìŠ¤
  const yearSelect = document.getElementById('birthYear');
  const monthSelect = document.getElementById('birthMonth');
  const daySelect = document.getElementById('birthDay');

  const now = new Date();
  const currentYear = now.getFullYear();

  for (let y = currentYear; y >= 1900; y--) {
    yearSelect.innerHTML += `<option value="${y}">${y}</option>`;
  }
  for (let m = 1; m <= 12; m++) {
    monthSelect.innerHTML += `<option value="${m}">${m}</option>`;
  }
  function updateDays() {
    const year = parseInt(yearSelect.value);
    const month = parseInt(monthSelect.value);
    const lastDay = new Date(year, month, 0).getDate();

    daySelect.innerHTML = '';
    for (let d = 1; d <= lastDay; d++) {
      daySelect.innerHTML += `<option value="${d}">${d}</option>`;
    }
  }
  yearSelect.addEventListener('change', updateDays);
  monthSelect.addEventListener('change', updateDays);
  updateDays(); // ì´ˆê¸° ì‹¤í–‰

  const emailInput = document.querySelector('input[name="email_id"]');
  const passwordInput = document.querySelector('input[name="password"]');
  const confirmPasswordInput = document.getElementById('confirmPasswordInput');
  const pwConfirmError = document.getElementById("pw-confirm-error-label");
  const nicknameInput = document.querySelector('input[name="nickname"]');
  const emailError = document.getElementById("email-error-label");
  const pwError = document.getElementById("pw-error-label");
  const nicknameError = document.getElementById("nickname-error-label");
  const submitButton = document.querySelector('button[type="submit"]');

  let isEmailFormatValid = false;
  let isEmailNotDuplicate = false;
  let isPasswordValid = false;
  let isNicknameFilled = false;
  let isPasswordConfirmed = false;

  const BASE_URL = /*[[${apiBaseUrl}]]*/ "https://api-katte.jp.ngrok.io/";
  console.log("âœ… BASE_URL =", BASE_URL);

  function validateEmailFormat(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }

  function validatePassword(password) {
    return /^(?=.*[0-9])(?=.*[!@#$%^&*])[A-Za-z0-9!@#$%^&*]{8,}$/.test(password);
  }

  function validateNickname(nickname) {
    return /^[ê°€-í£a-zA-Z0-9]{2,12}$/.test(nickname);
  }

  async function checkEmailDuplicate(email) {
    try {
      const url = `${BASE_URL}user/duplicate?email_id=${encodeURIComponent(email)}`;
      console.log("ğŸ“¡ ìš”ì²­ URL:", url);

      const response = await fetch(url, { method: "GET" });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const result = await response.json();  // JSON íŒŒì‹±
      console.log("ğŸ“¦ ì‘ë‹µ ê²°ê³¼:", result);

      // ì„œë²„ê°€ { duplicate: true/false } í˜•ì‹ìœ¼ë¡œ ë¦¬í„´í•œë‹¤ê³  ê°€ì •
      return !result;
    } catch (err) {
      console.error("âŒ ì´ë©”ì¼ ì¤‘ë³µ í™•ì¸ ì˜¤ë¥˜:", err);
      return false;
    }
  }

  async function validateEmail() {
    const email = emailInput.value.trim();
    isEmailFormatValid = validateEmailFormat(email);

    if (!isEmailFormatValid) {
      emailError.textContent = "ìœ íš¨í•œ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.";
      isEmailNotDuplicate = false;
    } else {
      // AJAX ì¤‘ë³µ ê²€ì‚¬
      const notDuplicate = await checkEmailDuplicate(email);
      isEmailNotDuplicate = notDuplicate;
      emailError.textContent = notDuplicate ? "" : "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.";
    }

    updateSubmitButton();
  }

  function validatePw() {
    const pw = passwordInput.value;
    isPasswordValid = validatePassword(pw);
    pwError.textContent = isPasswordValid ? "" : "íŠ¹ìˆ˜,ì˜ë¬¸ í¬í•¨ 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.";
    updateSubmitButton();
  }

  async function checkNicknameDuplicate(nickname) {
    try {
      const url = `${BASE_URL}user/nickname?nickname=${encodeURIComponent(nickname)}`;
      console.log("ğŸ“¡ ìš”ì²­ URL:", url);

      const response = await fetch(url, { method: "GET" });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const result = await response.json();  // JSON íŒŒì‹±
      console.log("ğŸ“¦ ì‘ë‹µ ê²°ê³¼:", result);
      return !result;
    } catch (err) {
      console.error("âŒ ì´ë©”ì¼ ì¤‘ë³µ í™•ì¸ ì˜¤ë¥˜:", err);
      return false;
    }
  }

  async function validateNick() {
    const nick = nicknameInput.value.trim();
    isNicknameFilled = validateNickname(nick);
    if (!isNicknameFilled) {
      nicknameError.textContent = "ë‹‰ë„¤ì„ì€ ì˜ì–´,í•œê¸€,ìˆ«ì ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.";
      isNicknameFilled = false;
    } else {
      // AJAX ì¤‘ë³µ ê²€ì‚¬
      const notDuplicate = await checkNicknameDuplicate(nick);
      isNicknameFilled = notDuplicate;
      nicknameError.textContent = notDuplicate ? "" : "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.";
      updateSubmitButton();
    }
  }

  function areAllTermsChecked() {
    const termsError = document.getElementById('terms-error-label');
    const over14 = document.querySelector('input[name="over14"]');
    const terms1 = document.querySelector('input[name="terms1"]');
    const terms2 = document.querySelector('input[name="terms2"]');

    const allChecked = over14.checked && terms1.checked && terms2.checked;

    if (!allChecked) {
      termsError.textContent = "í•„ìˆ˜ ì•½ê´€ì— ëª¨ë‘ ë™ì˜í•´ì£¼ì„¸ìš”.";
    } else {
      termsError.textContent = "";
    }

    return allChecked;
  }

  function updateSubmitButton() {
    const isFormValid = isEmailFormatValid && isEmailNotDuplicate && isPasswordValid && isNicknameFilled && areAllTermsChecked();
    submitButton.disabled = !isFormValid;
  }

  function validatePasswordMatch() {
    const password = passwordInput.value;
    const confirmPassword = confirmPasswordInput.value;

    isPasswordConfirmed = password === confirmPassword;
    pwError.textContent = isPasswordConfirmed ? "" : "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
    updateSubmitButton(); // ê¸°ì¡´ í•¨ìˆ˜
  }

  confirmPasswordInput.addEventListener("blur", validatePasswordMatch);
  passwordInput.addEventListener("input", validatePasswordMatch);

  // ì´ë²¤íŠ¸ ë°”ì¸ë”©
  emailInput.addEventListener("blur", validateEmail);
  passwordInput.addEventListener("blur", validatePw);
  nicknameInput.addEventListener("blur", validateNick);

  document.getElementById("over14").addEventListener("change", updateSubmitButton);
  document.getElementById("terms1").addEventListener("change", updateSubmitButton);
  document.getElementById("terms2").addEventListener("change", updateSubmitButton);

  document.querySelectorAll('input[name="terms"]').forEach(cb => {
    cb.addEventListener('change', updateSubmitButton);
  });
</script>
</body>
</html>