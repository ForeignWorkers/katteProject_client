<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Style Detail with Comment Popup</title>
  <link rel="stylesheet" href="/css/Stylepage/Style_detail.css" />
  <link rel="stylesheet" href="/css/fragments/Sidebar.css" />
</head>
<body>
<!-- ì‚¬ì´ë“œë°” -->
<div th:replace="Fragments/Sidebar :: sidebar"></div>

<!-- ============================================ -->
<!-- 2) ë©”ì¸ ë˜í¼(ì›ë˜ ìˆë˜ ì½˜í…ì¸ )                -->
<!-- ============================================ -->
<div class="div13">
  <img class="image-118" src="" />
  <div class="min-x-ili-0"></div>
  <!-- JSì—ì„œ ë‚ ì§œ ì±„ì›Œ ë„£ìŒ -->
  <div id="style-date"></div>
</div>

<!-- ìŠ¬ë¼ì´ë“œ ëŒ€í‘œ ì´ë¯¸ì§€ê°€ ì°í ê³³ -->
<div id="detail-images" class="detail-images"></div>

<div class="_5">ìƒí’ˆ íƒœê·¸</div>
<div class="group-975"></div>

<div class="div14">
  <div class="div15">
    <!-- ìŠ¤íƒ€ì¼ ì¢‹ì•„ìš” -->
    <div id="like-count" class="_23"></div>
    <img
            id="like-btn"
            class="mask-group"
            src="/img/heart_icon_no_clicked.png"
            alt="ì¢‹ì•„ìš” ë²„íŠ¼"
            style="cursor:pointer;"
    />
  </div>
  <div class="div16">
    <!-- ëŒ“ê¸€ ë²„íŠ¼ -->
    <img class="ellipse-71" src="/img/comment-btn.png" alt="ëŒ“ê¸€ ë²„íŠ¼" />
    <div class="_12">1</div>
  </div>
</div>

<div class="styletitle"></div>
<div class="stylecaption"></div>

<div class="hashtag"></div>

<!-- ìŠ¬ë¼ì´ë“œìš© ë²„íŠ¼ë“¤ -->
<img class="btn-prev" src="/img/leftbtn.png" alt="ì´ì „ ë²„íŠ¼" style="display:none; cursor:pointer;" />
<img class="btn-next" src="/img/rightbtn.png" alt="ë‹¤ìŒ ë²„íŠ¼" style="cursor:pointer;" />

<!-- ============================================ -->
<!-- 3) ëŒ“ê¸€ íŒì—…ìš© ì˜¤ë²„ë ˆì´ & íŒ¨ë„                 -->
<!-- ============================================ -->
<div class="overlay" style="display: none;"></div>
<div class="comment-panel" style="display: none;">
  <div class="comment-header">
    <span class="close-btn">&times;</span>
  </div>
  <div class="comment-post">
    <div class="post-author">
      <img class="author-avatar" src="" alt="ì•„ë°”íƒ€" />
      <span class="author-name">ì‘ì„±ì ë‹‰ë„¤ì„</span>
    </div>
    <div class="post-text">
      <span class="caption-text">ë³¸ë¬¸ í…ìŠ¤íŠ¸</span>
      <br />
      <span class="post-hashtags">#íƒœê·¸1 #íƒœê·¸2</span>
    </div>
    <div class="post-date">YYYY-MM-DD</div>
  </div>
  <div class="comment-input">
    <input type="text" class="comment-text" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." />
  </div>
  <div class="comment-list"></div>
</div>

<!-- ============================================ -->
<!-- 4) JavaScript                                -->
<!-- ============================================ -->
<script>
  const baseURL   = "http://localhost:9000/";
  const resourceUrl = "https://resources-katte.jp.ngrok.io/";
  const params = new URLSearchParams(window.location.search);
  const styleId = params.get('style_id');  // âœ… ì „ì—­ ì„ ì–¸

  // ìœ ì € ì •ë³´ ê°€ì ¸ì˜¤ëŠ” í—¬í¼
  async function fetchuserBean(userId) {
    const res = await fetch(`${baseURL}user?user_id=${userId}&email_id=`);
    if (!res.ok) return { nickname: 'ìµëª…', profile_url: null };
    return await res.json();
  }

  document.addEventListener('DOMContentLoaded', async function () {

    const res = await fetch(`/comment/list?style_id=${styleId}`);
    const comments = await res.json();


    // ëŒ“ê¸€ íŒì—… ì—´ê¸°/ë‹«ê¸° ë¡œì§
    const commentBtn = document.querySelector('.div16');
    const overlay = document.querySelector('.overlay');
    const commentPanel = document.querySelector('.comment-panel');
    const closeBtn = document.querySelector('.comment-panel .close-btn');
    const commentInput = document.querySelector('.comment-text');
    document.querySelector('._12').textContent = comments.length;


    commentBtn.addEventListener('click', () => {
      overlay.style.display = 'block';
      commentPanel.style.display = 'flex';
    });
    closeBtn.addEventListener('click', () => {
      overlay.style.display = 'none';
      commentPanel.style.display = 'none';
    });
    overlay.addEventListener('click', () => {
      overlay.style.display = 'none';
      commentPanel.style.display = 'none';
    });

    commentInput.addEventListener('focus', () => {
      commentInput.placeholder = '';
      commentInput.style.color = '#f9eeee';
    });
    commentInput.addEventListener('blur', () => {
      if (commentInput.value.trim() === '') {
        commentInput.placeholder = 'ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”...';
        commentInput.style.color = '#ccc';
      }
    });
  });

  document.addEventListener('DOMContentLoaded', async () => {
    const styleId = params.get('style_id');
    if (!styleId) return;

    const prevBtn = document.querySelector('.btn-prev');
    const nextBtn = document.querySelector('.btn-next');
    const imgRoot = document.getElementById('detail-images');
    const likeCountEl = document.getElementById('like-count');
    const likeBtnImg = document.getElementById('like-btn');

    const getUserlikeData = await fetch(`/content/isUserLikeAll`);
    const list = await getUserlikeData.json();

    fetch(`/content/style?style_id=${styleId}`)
            .then(res => res.ok ? res.json() : Promise.reject(res.statusText))
            .then(async data => {
              console.log(data);

              await loadComments(styleId);

              // ë‚ ì§œ ì„¸íŒ…
              const rawDate = data.created_date || '';
              const dateOnly = rawDate.split('T')[0] || '';
              document.getElementById('style-date').textContent = dateOnly;
              document.querySelector('.comment-post .post-date').textContent = dateOnly;

              // í—¤ë” ìœ ì € ì„¸íŒ…
              const userBean = await fetchuserBean(data.user_id);

              //ëŒ“ê¸€ ì°½ ì„¸íŒ…
              document.querySelector('.author-name').textContent = userBean.nickname;

              document.querySelector('.caption-text').textContent = data.caption ?? '';
              document.querySelector('.post-hashtags').textContent =
                      (data.hashtags || []).map(ht => `#${ht}`).join(' ');

              document.querySelector('.author-avatar').src = userBean.profile_url
                      ? userBean.profile_url
                      : resourceUrl + "profile/basic_profile_00.png";

              document.querySelector('.min-x-ili-0').textContent = userBean.nickname;
              document.querySelector('.image-118').src = userBean.profile_url
                      ? userBean.profile_url
                      : resourceUrl + "profile/basic_profile_00.png";

              // ì œëª©/ìº¡ì…˜/í•´ì‹œíƒœê·¸ ì„¸íŒ…
              document.querySelector('.styletitle').textContent = data.style_title || '';
              document.querySelector('.stylecaption').textContent = data.caption || '';
              const htContainer = document.querySelector('.hashtag');
              htContainer.innerHTML = '';
              (data.hashtags || []).forEach(ht => {
                const span = document.createElement('span');
                span.classList.add('tag');
                span.textContent = `#${ht}`;
                htContainer.appendChild(span);
              });

              // ìŠ¤íƒ€ì¼ ì¢‹ì•„ìš” ì´ˆê¸°í™”
              likeCountEl.textContent = data.like_count ?? 0;
              const resLike = await fetch(`/style/isLikeExist?style_id=${styleId}`)
              const isHave = await resLike.json();

              console.log("@#@#@#!@#!@#!@#" + isHave);
              likeBtnImg.src = isHave
                      ? '/img/heart_icon_clicked.png'
                      : '/img/heart_icon_no_clicked.png';

              // ìŠ¤íƒ€ì¼ ì¢‹ì•„ìš” í´ë¦­ í† ê¸€
              likeBtnImg.addEventListener('click', async () => {
                const resp = await fetch(`/style/like?style_id=${styleId}`);
                const liked = await resp.json();
                likeBtnImg.src = liked
                        ? '/img/heart_icon_clicked.png'
                        : '/img/heart_icon_no_clicked.png';
                likeCountEl.textContent = liked
                        ? (+likeCountEl.textContent + 1)
                        : (+likeCountEl.textContent - 1);
              });

              // ëŒ“ê¸€ ì¢‹ì•„ìš” ë²„íŠ¼ ì´ˆê¸° ìœ„ì¹˜ ì„¤ì • & í´ë¦­ í† ê¸€
              document.querySelectorAll('.comment-like-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                  const liked = btn.dataset.liked === 'true';
                  btn.src = liked
                          ? '/img/heart_icon_no_clicked.png'
                          : '/img/heart_icon_clicked.png';
                  btn.dataset.liked = (!liked).toString();
                });
              });

              //íƒœê·¸ ì´ë¯¸ì§€ ì¶”ê°€
              const tagContainer = document.querySelector(".group-975");
              tagContainer.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì œê±°
              const res = await fetch(`/content/stylePrdouct?style_id=${styleId}`)
              const products = await res.json();

              for (const productId of products) {
                const wrapper = document.createElement("div");
                const res = await fetch(`/content/getProduct?product_id=${productId}`)
                const productData = await res.json();
                wrapper.className = "_1";

                wrapper.innerHTML = `
  <a class="product-link" href="/product/${productId}" style="text-decoration: none; color: inherit;">
    <img class="image-125" src="${resourceUrl}images/${productId}/${productId}_1.png" />
    <div class="hysteric-glamour-hyst-280-000">
      <span>
        <span class="hysteric-glamour-hyst-280-000-span">
          ${productData.product_name_kor ?? 'ìƒí’ˆëª… ì—†ìŒ'}<br><br>
        </span>
        <span class="hysteric-glamour-hyst-280-000-span2">
          ${Number(productData.release_price).toLocaleString() ?? '-'} ì›
        </span>
      </span>
    </div>
  </a>
`;

                tagContainer.appendChild(wrapper);
              }

              // ì´ë¯¸ì§€ ìŠ¬ë¼ì´ë“œ ë¡œì§
              const count = data.img_count;
              console.log("count" + count);

              if (count <= 0) {
                imgRoot.textContent = 'ë“±ë¡ëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.';
                return;
              }
              const urls = Array.from(
                      {length: count},
                      (_, i) => `${resourceUrl}style/${styleId}/${styleId}_${i + 1}.png`
              );
              const mainImg = document.createElement('img');
              mainImg.classList.add('detail-img');
              imgRoot.appendChild(mainImg);
              let idx = 0;

              function render() {
                mainImg.src = urls[idx];
                prevBtn.style.display = idx > 0 ? 'block' : 'none';
                nextBtn.style.display = idx < urls.length - 1 ? 'block' : 'none';
              }

              nextBtn.addEventListener('click', () => {
                if (idx < urls.length - 1) {
                  idx++;
                  render();
                }
              });
              prevBtn.addEventListener('click', () => {
                if (idx > 0) {
                  idx--;
                  render();
                }
              });
              render();
            })
            .catch(err => {
              console.error('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', err);
              imgRoot.textContent = 'ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            });

    //ëŒ“ê¸€ ì˜ì—­
    const commentList = document.querySelector('.comment-list');
    const commentInput = document.querySelector('.comment-text');

    // ëŒ“ê¸€ ë Œë”ë§ í•¨ìˆ˜
    async function loadComments() {
      const res = await fetch(`/comment/list?style_id=${styleId}`);
      const comments = await res.json();

      commentList.innerHTML = ''; // ì´ˆê¸°í™”
      for (const c of comments) {
        const user = await fetchuserBean(c.user_id);
        const item = document.createElement('div');
        item.className = 'comment-item';
        item.dataset.commentId = c.id;

        item.innerHTML = `
      <img class="comment-avatar" src="${user.profile_url || resourceUrl + 'profile/basic_profile_00.png'}" />
      <div class="comment-main">
        <span class="comment-author">${user.nickname}</span>
        <div class="comment-text-item">${c.content}</div>
        <div class="comment-meta">
          <span class="comment-date">${formatDate(c.create_at)}</span>
        </div>
      </div>
    `;

        commentList.appendChild(item);
      }
    }

// ëŒ“ê¸€ ë“±ë¡ (Enter ì…ë ¥ ì‹œ)
    commentInput.addEventListener('keypress', async (e) => {
      if (e.key === 'Enter' && commentInput.value.trim() !== '') {
        if (currentUserId === -1) {
          alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
          return;
        }

        if (commentRestricted) {
          alert("ğŸš« í˜„ì¬ ëŒ“ê¸€ ì‘ì„±ì´ ì œí•œëœ ìƒíƒœì…ë‹ˆë‹¤.");
          return;
        }

        const comment = commentInput.value.trim();
        const res = await fetch(`/comment/add?style_id=${styleId}&content=${comment}`);
        const result = await res.json();

        if (result) {
          commentInput.value = '';
          await loadComments();
        } else {
          alert("ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨");
        }
      }
    });

// ë‚ ì§œ í¬ë§· í•¨ìˆ˜
    function formatDate(isoString) {
      const date = new Date(isoString);
      const now = new Date();
      const diffMin = Math.floor((now - date) / 60000);

      if (diffMin < 1) return 'ë°©ê¸ˆ ì „';
      if (diffMin < 60) return `${diffMin}ë¶„ ì „`;
      const diffHour = Math.floor(diffMin / 60);
      if (diffHour < 24) return `${diffHour}ì‹œê°„ ì „`;
      return date.toISOString().split('T')[0]; // YYYY-MM-DD
    }
  });
</script>
<script th:inline="javascript">
  const currentUserId = [[${userId}]];
  const commentRestricted = [[${commentRestricted}]]; // true or false
</script>
</body>
</html>
