<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Style Detail with Comment Popup</title>
  <link rel="stylesheet" href="/css/Stylepage/Style_detail.css" />
  <link rel="stylesheet" href="/css/fragments/Sidebar.css" />
</head>
<body>
<!-- 사이드바 -->
<div th:replace="Fragments/Sidebar :: sidebar"></div>

<!-- ============================================ -->
<!-- 2) 메인 래퍼(원래 있던 콘텐츠)                -->
<!-- ============================================ -->
<div class="div13">
  <img class="image-118" src="image-1180.png" />
  <div class="min-x-ili-0"></div>
  <!-- JS에서 날짜 채워 넣음 -->
  <div id="style-date"></div>
</div>

<!-- 슬라이드 대표 이미지가 찍힐 곳 -->
<div id="detail-images" class="detail-images"></div>

<div class="_5">상품 태그</div>
<div class="group-975">
  <div class="_1">
    <img class="image-125" src="" />
    <div class="hysteric-glamour-hyst-280-000">
      <span>
        <span class="hysteric-glamour-hyst-280-000-span">
          Hysteric GlamourHyst...
          <br /><br />
        </span>
        <span class="hysteric-glamour-hyst-280-000-span2">280,000원</span>
      </span>
    </div>
  </div>
</div>

<div class="div14">
  <div class="div15">
    <!-- 스타일 좋아요 -->
    <div id="like-count" class="_23"></div>
    <img
            id="like-btn"
            class="mask-group"
            src="/img/heart_icon_no_clicked.png"
            alt="좋아요 버튼"
            style="cursor:pointer;"
    />
  </div>
  <div class="div16">
    <!-- 댓글 버튼 -->
    <img class="ellipse-71" src="/img/comment-btn.png" alt="댓글 버튼" />
    <div class="_12">1</div>
  </div>
</div>

<div class="styletitle"></div>
<div class="stylecaption"></div>

<div class="hashtag"></div>

<!-- 슬라이드용 버튼들 -->
<img class="btn-prev" src="/img/leftbtn.png" alt="이전 버튼" style="display:none; cursor:pointer;" />
<img class="btn-next" src="/img/rightbtn.png" alt="다음 버튼" style="cursor:pointer;" />

<!-- ============================================ -->
<!-- 3) 댓글 팝업용 오버레이 & 패널                 -->
<!-- ============================================ -->
<div class="overlay" style="display: none;"></div>
<div class="comment-panel" style="display: none;">
  <div class="comment-header">
    <span class="close-btn">&times;</span>
  </div>
  <div class="comment-post">
    <div class="post-author">
      <img class="author-avatar" src="image-1180.png" alt="아바타" />
      <span class="author-name">min_x_ili_0</span>
    </div>
    <div class="post-text">
      내 jeans 봐.
      <span class="post-hashtags">
        #5뭐입챌린지 #여름준비 #반팔코디 #데일리슈즈 #여름필수템 #캐주얼룩
      </span>
    </div>
    <div class="post-date">2025-3-23</div>
  </div>
  <div class="comment-input">
    <input type="text" class="comment-text" placeholder="댓글을 입력하세요..." />
  </div>
  <div class="comment-list">
    <!-- 댓글 아이템 1 -->
    <div class="comment-item" data-comment-id="1">
      <img class="comment-avatar" src="image-1250.png" alt="아바타" />
      <div class="comment-main">
        <span class="comment-author">cat_love</span>
        <div class="comment-text-item">정말 기가막힌 옷이네</div>
        <div class="comment-meta">
          <span class="comment-date">2025-3-23</span>
          <span class="reply-link">답글쓰기</span>
          <img class="comment-report-btn" src="/img/report_button.png" alt="신고" />
        </div>
      </div>
      <!-- 댓글 좋아요 버튼 -->
      <img
              class="comment-like-btn"
              src="/img/heart_icon_no_clicked.png"
              alt="댓글 좋아요"
              style="cursor:pointer; width:16px; height:16px;"
              data-liked="false"
      />
    </div>
    <!-- 댓글 아이템 2 -->
    <div class="comment-item" data-comment-id="2">
      <img class="comment-avatar" src="image-1260.png" alt="아바타" />
      <div class="comment-main">
        <span class="comment-author">xililo_wedx</span>
        <div class="comment-text-item">신발 너무 예뻐요ㅜ</div>
        <div class="comment-meta">
          <span class="comment-date">2시간 전</span>
          <span class="reply-link">답글쓰기</span>
          <img class="comment-report-btn" src="/img/report_button.png" alt="신고" />
        </div>
      </div>
      <img
              class="comment-like-btn"
              src="/img/heart_icon_clicked.png"
              alt="댓글 좋아요"
              style="cursor:pointer; width:16px; height:16px;"
              data-liked="true"
      />
    </div>
    <!-- 댓글 아이템 3 (대댓글) -->
    <div class="comment-item reply" data-comment-id="3">
      <img class="comment-avatar" src="image-1270.png" alt="아바타" />
      <div class="comment-main">
        <span class="comment-author">min_x_ili_0</span>
        <div class="comment-text-item">헤헤 감사합니다</div>
        <div class="comment-meta">
          <span class="comment-date">2시간 전</span>
          <span class="reply-link">답글쓰기</span>
          <img class="comment-report-btn" src="/img/report_button.png" alt="신고" />
        </div>
      </div>
      <img
              class="comment-like-btn"
              src="/img/heart_icon_no_clicked.png"
              alt="댓글 좋아요"
              style="cursor:pointer; width:16px; height:16px;"
              data-liked="false"
      />
    </div>
  </div>
</div>

<!-- ============================================ -->
<!-- 4) JavaScript                                -->
<!-- ============================================ -->
<script>
  const baseURL   = "http://localhost:9000/"

  // 유저 정보 가져오는 헬퍼
  async function fetchuserBean(userId) {
    const res = await fetch(`${baseURL}user?user_id=${userId}&email_id=`);
    if (!res.ok) return { nickname: '익명', profile_url: null };
    return await res.json();
  }

  document.addEventListener('DOMContentLoaded', function() {
    // 댓글 팝업 열기/닫기 로직
    const commentBtn   = document.querySelector('.ellipse-71');
    const overlay      = document.querySelector('.overlay');
    const commentPanel = document.querySelector('.comment-panel');
    const closeBtn     = document.querySelector('.comment-panel .close-btn');
    const commentInput = document.querySelector('.comment-text');

    commentBtn.addEventListener('click', () => {
      overlay.style.display = 'block';
      commentPanel.style.display = 'flex';
    });
    closeBtn.addEventListener('click', () => {
      overlay.style.display = 'none';
      commentPanel.style.display = 'none';
    });
    overlay.addEventListener('click', () => {
      overlay.style.display = 'none';
      commentPanel.style.display = 'none';
    });

    commentInput.addEventListener('focus', () => {
      commentInput.placeholder = '';
      commentInput.style.color = '#f9eeee';
    });
    commentInput.addEventListener('blur', () => {
      if (commentInput.value.trim() === '') {
        commentInput.placeholder = '댓글을 입력하세요...';
        commentInput.style.color = '#ccc';
      }
    });
  });

  document.addEventListener('DOMContentLoaded', async () => {
    const resourceUrl = "https://resources-katte.jp.ngrok.io/";
    const params = new URLSearchParams(window.location.search);
    const styleId = params.get('style_id');
    if (!styleId) return;

    const prevBtn = document.querySelector('.btn-prev');
    const nextBtn = document.querySelector('.btn-next');
    const imgRoot = document.getElementById('detail-images');
    const likeCountEl = document.getElementById('like-count');
    const likeBtnImg = document.getElementById('like-btn');

    const getUserlikeData = await fetch(`/content/isUserLikeAll`);
    const list = await getUserlikeData.json();

    fetch(`/content/style?style_id=${styleId}`)
            .then(res => res.ok ? res.json() : Promise.reject(res.statusText))
            .then(async data => {
              // 날짜 세팅
              const rawDate = data.created_date || '';
              const dateOnly = rawDate.split('T')[0] || '';
              document.getElementById('style-date').textContent = dateOnly;
              document.querySelector('.comment-post .post-date').textContent = dateOnly;

              // 헤더 유저 세팅
              const userBean = await fetchuserBean(data.user_id);
              document.querySelector('.min-x-ili-0').textContent = userBean.nickname;
              document.querySelector('.image-118').src = userBean.profile_url
                      ? userBean.profile_url
                      : resourceUrl + "profile/basic_profile_00.png";

              // 제목/캡션/해시태그 세팅
              document.querySelector('.styletitle').textContent = data.style_title || '';
              document.querySelector('.stylecaption').textContent = data.caption || '';
              const htContainer = document.querySelector('.hashtag');
              htContainer.innerHTML = '';
              (data.hashtags || []).forEach(ht => {
                const span = document.createElement('span');
                span.classList.add('tag');
                span.textContent = `#${ht}`;
                htContainer.appendChild(span);
              });

              // 스타일 좋아요 초기화
              likeCountEl.textContent = data.like_count ?? 0;
              likeBtnImg.src = list.includes(Number(styleId))
                      ? '/img/heart_icon_clicked.png'
                      : '/img/heart_icon_no_clicked.png';

              // 스타일 좋아요 클릭 토글
              likeBtnImg.addEventListener('click', async () => {
                const resp = await fetch(`/style/like?style_id=${styleId}`);
                const liked = await resp.json();
                likeBtnImg.src = liked
                        ? '/img/heart_icon_clicked.png'
                        : '/img/heart_icon_no_clicked.png';
                likeCountEl.textContent = liked
                        ? (+likeCountEl.textContent + 1)
                        : (+likeCountEl.textContent - 1);
              });

              // 댓글 좋아요 버튼 초기 위치 설정 & 클릭 토글
              document.querySelectorAll('.comment-like-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                  const liked = btn.dataset.liked === 'true';
                  btn.src = liked
                          ? '/img/heart_icon_no_clicked.png'
                          : '/img/heart_icon_clicked.png';
                  btn.dataset.liked = (!liked).toString();
                });
              });

              document.querySelector(".image-125").src = resourceUrl+'/';

              // 이미지 슬라이드 로직
              const count = data.img_count;
              if (count <= 0) {
                imgRoot.textContent = '등록된 이미지가 없습니다.';
                return;
              }
              const urls = Array.from(
                      {length: count},
                      (_, i) => `${resourceUrl}style/${styleId}/${styleId}_${i + 1}.png`
              );
              const mainImg = document.createElement('img');
              mainImg.classList.add('detail-img');
              imgRoot.appendChild(mainImg);
              let idx = 0;

              function render() {
                mainImg.src = urls[idx];
                prevBtn.style.display = idx > 0 ? 'block' : 'none';
                nextBtn.style.display = idx < urls.length - 1 ? 'block' : 'none';
              }

              nextBtn.addEventListener('click', () => {
                if (idx < urls.length - 1) {
                  idx++;
                  render();
                }
              });
              prevBtn.addEventListener('click', () => {
                if (idx > 0) {
                  idx--;
                  render();
                }
              });
              render();
            })
            .catch(err => {
              console.error('이미지 로드 실패:', err);
              imgRoot.textContent = '이미지를 불러올 수 없습니다.';
            });
  });
</script>
</body>
</html>
