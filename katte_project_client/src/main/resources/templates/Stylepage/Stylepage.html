<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Style Page</title>
  <!-- 기존 CSS -->
  <link rel="stylesheet" href="/css/Stylepage/Stylepage.css" />
  <link rel="stylesheet" href="/css/fragments/Sidebar.css" />
</head>
<body>

<!-- 사이드바 -->
<div th:replace="Fragments/Sidebar :: sidebar"></div>

<div class="wrapper">
  <!-- 오늘의 해시태그 (위쪽 탐색용) -->
  <section class="today-hashtags">
    <h2>오늘의 해시태그</h2>
    <div class="hashtags">
      <span class="tag">#썸머룩</span>
      <span class="tag">#반팔코디</span>
      <span class="tag">#여름코디</span>
      <span class="tag">#최애신발</span>
      <span class="tag">#오오티디</span>
      <span class="tag">#덥다</span>
      <span class="tag">#느좋</span>
      <span class="tag">#New</span>
    </div>
  </section>

  <!-- 스타일 카드 컨테이너 -->
  <div id="style-container" class="style-grid"></div>

  <!-- 카드 템플릿 -->
  <template id="style-card-template">
    <div class="style-card">
      <div class="card-header">
        <img class="avatar" src="" alt="프사" />
        <span class="username"></span>
      </div>
      <div class="card-image">
        <!-- JS에서 imageUrls 만큼 <img> 태그를 동적으로 삽입 -->
      </div>
      <div class="card-body">
        <h3 class="title"></h3>
        <p class="caption"></p>
        <!-- 캡션 바로 아래: 등록된 해시태그를 여기에 렌더링 -->
        <div class="hashtags-list"></div>
      </div>
      <div class="card-footer">
        <button class="like-button">♡</button>
        <span class="like-count">0</span>
      </div>
    </div>
  </template>
</div>

<script>
  const container = document.getElementById('style-container');
  const tpl       = document.getElementById('style-card-template');
  let page        = 0;
  const size      = 10;
  let loading     = false;

  async function fetchuserBean(userId) {
    const res = await fetch(`http://localhost:9000/user?user_id=${userId}&email_id=`);
    if (!res.ok) {
      return { nickname: '익명', profile_url: null };
    }
    return await res.json();
  }

  async function loadStyles() {
    if (loading) return;
    loading = true;

    // endpoint 및 offset 반영
    const offset = page * size;
    const res    = await fetch(
            `http://localhost:9000/content/style/recent?size=${size}&offset=${offset}`
    );
    const data   = await res.json();
    const resourceUrl = "https://resources-katte.jp.ngrok.io/";

    if (!data || data.length === 0) {
      window.removeEventListener('scroll', handleScroll);
      loading = false;
      return;
    }

    for (const item of data) {
      const card = tpl.content.cloneNode(true);

      // 닉네임·프로필 가져오기
      const userBean = await fetchuserBean(item.user_id);
      card.querySelector('.username').textContent = userBean.nickname;
      card.querySelector('.avatar').src = userBean.profile_url
              ? userBean.profile_url
              : resourceUrl + "profile/basic_profile_00.png";

      // 이미지 렌더링 (첫 장만 예시)
      const imgContainer = card.querySelector('.card-image');
      imgContainer.innerHTML = '';
      const img = document.createElement('img');
      img.src = resourceUrl + "style/" + item.id + "/" + item.id + "_1.png";
      img.alt = item.caption || '';
      img.style = 'margin-right:4px;';
      imgContainer.appendChild(img);

      // 제목·캡션
      card.querySelector('.title').textContent   = item.style_title || '';
      card.querySelector('.caption').textContent = item.caption     || '';

      // -- 여기서 등록된 해시태그(item.hashtags) 렌더링 --
      const tagContainer = card.querySelector('.hashtags-list');
      tagContainer.innerHTML = '';
      (item.hashtags || []).forEach(ht => {
        const span = document.createElement('span');
        span.className   = 'tag';
        span.textContent = `#${ht}`;
        tagContainer.append(span);
      });


      // 좋아요 버튼 초기 상태
      const likeBtn = card.querySelector('.like-button');
      const likeCnt = card.querySelector('.like-count');
      likeCnt.textContent = item.like_count ?? 0;
      likeBtn.textContent = item.likedByCurrentUser ? '❤️' : '♡';

      likeBtn.addEventListener('click', async () => {
        const resp  = await fetch(`/style/like?style_id=${item.id}`)
        const liked = await resp.json();
        likeBtn.textContent = liked ? '❤️' : '♡';
        likeCnt.textContent = liked
                ? (+likeCnt.textContent + 1)
                : (+likeCnt.textContent - 1);
      });

      container.appendChild(card);
    }

    page++;
    loading = false;
  }

  function handleScroll() {
    if (window.innerHeight + window.pageYOffset >= document.body.offsetHeight - 200) {
      loadStyles();
    }
  }

  window.addEventListener('scroll', handleScroll);
  window.addEventListener('load', loadStyles);
</script>
</body>
</html>
